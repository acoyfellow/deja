---
import Base from '../layouts/Base.astro';
import SEO from '../components/SEO.astro';

const learnExample = `{
  "trigger": "deploying to production",
  "learning": "always run wrangler deploy --dry-run first",
  "confidence": 0.9,
  "scope": "shared",
  "reason": "caught a typo in wrangler.toml",
  "source": "deploy-agent"
}`;

const injectExample = `{
  "context": "about to deploy the worker",
  "scopes": ["shared", "agent:deploy-bot"],
  "limit": 5
}`;

const queryExample = `{
  "query": "deployment issues",
  "scopes": ["shared"],
  "limit": 10
}`;

const quickStartCode = `# Install wrangler
npm install -g wrangler

# Create vectorize index
wrangler vectorize create deja-embeddings --dimensions 384 --metric cosine

# Set your API key
wrangler secret put API_KEY

# Deploy
wrangler deploy`;

const universalMcpConfig = `{
  "mcpServers": {
    "deja": {
      "type": "http",
      "url": "https://deja.your-subdomain.workers.dev/mcp",
      "headers": {
        "Authorization": "Bearer \${DEJA_API_KEY}"
      }
    }
  }
}`;

const claudeCliInstall = `claude mcp add --transport http deja https://deja.your-subdomain.workers.dev/mcp \
  --header "Authorization: Bearer $DEJA_API_KEY"`;

const continueInstall = `mcpServers:
  - name: deja
    type: streamable-http
    url: https://deja.your-subdomain.workers.dev/mcp
    headers:
      Authorization: Bearer \${secrets.DEJA_API_KEY}`;

const clineInstall = `{
  "mcpServers": {
    "deja": {
      "type": "http",
      "url": "https://deja.your-subdomain.workers.dev/mcp",
      "headers": {
        "Authorization": "Bearer \${DEJA_API_KEY}"
      }
    }
  }
}`;
---

<Base title="Documentation — deja" variant="content">
  <SEO
    slot="head"
    title="Documentation — deja"
    description="API reference and integration guides for deja. Learn how to use the REST API, MCP protocol, and client library for persistent agent memory."
    keywords="deja api, mcp server, agent memory api, cloudflare workers api, vectorize, semantic search api"
    path="/docs"
    type="article"
    section="Documentation"
    breadcrumbs={[{ name: 'Docs', path: '/docs' }]}
  />
  <section class="pt-16 pb-8">
    <div class="bg-void/90 backdrop-blur-sm border border-brass/10 rounded-sm p-8 md:p-10 shadow-hero">
      <div class="font-mono text-[11px] font-bold tracking-widest uppercase text-brass mb-4">Documentation</div>
      <h1 class="font-serif-sc text-4xl md:text-5xl font-bold tracking-tight m-0 mb-4">
        API Reference
      </h1>
      <p class="font-serif font-light text-lg text-chrome-dark max-w-3xl m-0">
        Everything you need to give your agents durable memory.
      </p>
    </div>
  </section>

  <section class="mt-12">
    <h2 class="font-serif font-semibold text-2xl tracking-tight m-0 mb-6 flex items-center gap-3">
      <span class="text-brass">#</span> Quick Start
    </h2>
    <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
      <p class="font-serif font-light text-chrome-dark m-0 mb-4">Deploy deja to your Cloudflare account:</p>
      <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-4 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code">{quickStartCode}</pre>
    </div>
  </section>

  <section class="mt-12">
    <h2 class="font-serif font-semibold text-2xl tracking-tight m-0 mb-6 flex items-center gap-3">
      <span class="text-brass">#</span> Authentication
    </h2>
    <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
      <p class="font-serif font-light text-chrome-dark m-0 mb-4">All mutating endpoints require a Bearer token:</p>
      <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-4 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code">Authorization: Bearer YOUR_API_KEY</pre>
      <p class="font-serif font-light text-chrome-dark m-0 mt-4 text-sm">
        Public endpoints (<code class="text-brass">/</code>, <code class="text-brass">/inject</code>, <code class="text-brass">/query</code>) work without auth for read operations.
      </p>
    </div>
  </section>

  <section class="mt-12">
    <h2 class="font-serif font-semibold text-2xl tracking-tight m-0 mb-6 flex items-center gap-3">
      <span class="text-brass">#</span> Universal MCP Setup (Any Agent)
    </h2>
    <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
      <p class="font-serif font-light text-chrome-dark m-0 mb-4">
        deja is an MCP server. If your assistant supports MCP, it can use deja.
        Point your client to <code class="text-brass">/mcp</code> and pass your bearer token.
      </p>

      <div class="mb-6">
        <h3 class="font-mono text-sm text-brass mb-3">Generic MCP config</h3>
        <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-4 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code whitespace-pre-wrap">{universalMcpConfig}</pre>
      </div>

      <div class="mb-6">
        <h3 class="font-mono text-sm text-brass mb-3">Install examples by client</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <p class="font-mono text-xs text-brass mb-2">Claude Code CLI</p>
            <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-3 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code whitespace-pre-wrap">{claudeCliInstall}</pre>
          </div>
          <div>
            <p class="font-mono text-xs text-brass mb-2">Continue (config.yaml)</p>
            <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-3 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code whitespace-pre-wrap">{continueInstall}</pre>
          </div>
          <div>
            <p class="font-mono text-xs text-brass mb-2">Cline / JSON clients</p>
            <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-3 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code whitespace-pre-wrap">{clineInstall}</pre>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <h3 class="font-mono text-sm text-brass mb-3">Available MCP Tools</h3>
        <div class="space-y-3">
          <div class="flex items-start gap-3"><code class="font-mono text-xs text-brass bg-brass/10 px-2 py-0.5 rounded">learn</code><span class="font-serif text-sm text-chrome-dark">Store a memory for future recall</span></div>
          <div class="flex items-start gap-3"><code class="font-mono text-xs text-brass bg-brass/10 px-2 py-0.5 rounded">inject</code><span class="font-serif text-sm text-chrome-dark">Retrieve context-relevant memories</span></div>
          <div class="flex items-start gap-3"><code class="font-mono text-xs text-brass bg-brass/10 px-2 py-0.5 rounded">query</code><span class="font-serif text-sm text-chrome-dark">Semantic search across memory</span></div>
          <div class="flex items-start gap-3"><code class="font-mono text-xs text-brass bg-brass/10 px-2 py-0.5 rounded">forget</code><span class="font-serif text-sm text-chrome-dark">Delete a specific memory</span></div>
          <div class="flex items-start gap-3"><code class="font-mono text-xs text-brass bg-brass/10 px-2 py-0.5 rounded">list</code><span class="font-serif text-sm text-chrome-dark">List memories by scope</span></div>
          <div class="flex items-start gap-3"><code class="font-mono text-xs text-brass bg-brass/10 px-2 py-0.5 rounded">stats</code><span class="font-serif text-sm text-chrome-dark">Read memory usage/statistics</span></div>
        </div>
      </div>

      <p class="font-serif font-light text-chrome-dark m-0 text-sm">
        If it speaks MCP, it works with deja.
      </p>
    </div>
  </section>

  <section class="mt-12">
    <h2 class="font-serif font-semibold text-2xl tracking-tight m-0 mb-6 flex items-center gap-3">
      <span class="text-brass">#</span> REST Endpoints
    </h2>

    <div class="space-y-6">
      <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-xs font-bold px-2 py-1 bg-brass/20 text-brass rounded">POST</span>
          <code class="font-mono text-sm text-chrome">/learn</code>
        </div>
        <p class="font-serif font-light text-chrome-dark m-0 mb-4">Store a new learning with semantic embedding.</p>
        <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-4 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code">{learnExample}</pre>
        <div class="mt-4 text-sm">
          <p class="font-mono text-brass mb-2">Parameters:</p>
          <ul class="font-serif font-light text-chrome-dark pl-4 space-y-1">
            <li><code class="text-brass">trigger</code> (required) — What triggers this memory</li>
            <li><code class="text-brass">learning</code> (required) — What was learned</li>
            <li><code class="text-brass">confidence</code> (required) — 0.0 to 1.0, memories below 0.3 are auto-cleaned</li>
            <li><code class="text-brass">scope</code> — "shared", "agent:id", or "session:id" (default: "shared")</li>
            <li><code class="text-brass">reason</code> — Optional context</li>
            <li><code class="text-brass">source</code> — Optional source identifier</li>
          </ul>
        </div>
      </div>

      <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-xs font-bold px-2 py-1 bg-brass/20 text-brass rounded">POST</span>
          <code class="font-mono text-sm text-chrome">/inject</code>
        </div>
        <p class="font-serif font-light text-chrome-dark m-0 mb-4">Get relevant memories formatted for prompt injection.</p>
        <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-4 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code">{injectExample}</pre>
        <p class="font-serif font-light text-chrome-dark m-0 mt-4 text-sm">
          Returns a formatted string ready to inject into your agent's system prompt.
        </p>
      </div>

      <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-xs font-bold px-2 py-1 bg-brass/20 text-brass rounded">POST</span>
          <code class="font-mono text-sm text-chrome">/query</code>
        </div>
        <p class="font-serif font-light text-chrome-dark m-0 mb-4">Semantic search over stored memories.</p>
        <pre class="code-block bg-void-deep border border-brass/10 rounded-sm p-4 font-mono text-xs leading-relaxed text-chrome-dark overflow-x-auto shadow-code">{queryExample}</pre>
      </div>

      <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-xs font-bold px-2 py-1 bg-void-deep text-chrome-dark border border-brass/20 rounded">GET</span>
          <code class="font-mono text-sm text-chrome">/stats</code>
        </div>
        <p class="font-serif font-light text-chrome-dark m-0">Returns counts of learnings and secrets by scope.</p>
      </div>

      <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-xs font-bold px-2 py-1 bg-void-deep text-chrome-dark border border-brass/20 rounded">GET</span>
          <code class="font-mono text-sm text-chrome">/learnings?scope=shared</code>
        </div>
        <p class="font-serif font-light text-chrome-dark m-0">List all learnings, optionally filtered by scope.</p>
      </div>

      <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-xs font-bold px-2 py-1 bg-red-500/20 text-red-400 rounded">DELETE</span>
          <code class="font-mono text-sm text-chrome">/learning/:id</code>
        </div>
        <p class="font-serif font-light text-chrome-dark m-0">Delete a specific learning by ID. Requires authentication.</p>
      </div>
    </div>
  </section>

  <section class="mt-12">
    <h2 class="font-serif font-semibold text-2xl tracking-tight m-0 mb-6 flex items-center gap-3">
      <span class="text-brass">#</span> Scopes
    </h2>
    <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
      <p class="font-serif font-light text-chrome-dark m-0 mb-4">Memories are organized by scope for isolation and relevance:</p>
      <div class="space-y-4">
        <div class="flex items-start gap-4">
          <code class="font-mono text-sm text-brass whitespace-nowrap">shared</code>
          <p class="font-serif font-light text-chrome-dark m-0">Global memories accessible by all agents. Auto-cleaned after 30 days with low confidence.</p>
        </div>
        <div class="flex items-start gap-4">
          <code class="font-mono text-sm text-brass whitespace-nowrap">agent:&lt;id&gt;</code>
          <p class="font-serif font-light text-chrome-dark m-0">Agent-specific memories. Use for learnings unique to a particular agent's behavior.</p>
        </div>
        <div class="flex items-start gap-4">
          <code class="font-mono text-sm text-brass whitespace-nowrap">session:&lt;id&gt;</code>
          <p class="font-serif font-light text-chrome-dark m-0">Temporary session memories. Auto-cleaned after 7 days — use for ephemeral context.</p>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-12">
    <h2 class="font-serif font-semibold text-2xl tracking-tight m-0 mb-6 flex items-center gap-3">
      <span class="text-brass">#</span> For AI Agents
    </h2>
    <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
      <p class="font-serif font-light text-chrome-dark m-0">
        A machine-readable summary is available at <a href="/llms.txt" class="text-brass hover:text-brass-light underline">/llms.txt</a> for AI agents to quickly understand deja's API.
      </p>
    </div>
  </section>

  <section class="mt-12 mb-8">
    <h2 class="font-serif font-semibold text-2xl tracking-tight m-0 mb-6 flex items-center gap-3">
      <span class="text-brass">#</span> Compatibility Notes
    </h2>
    <div class="bg-steel border border-brass/10 rounded-sm p-6 shadow-card">
      <ul class="font-serif font-light text-chrome-dark pl-4 space-y-2 m-0">
        <li>Use <code class="text-brass">type: http</code>, <code class="text-brass">transport: http</code>, or your client's equivalent key.</li>
        <li>Always target <code class="text-brass">https://.../mcp</code> (not the root URL).</li>
        <li>Pass <code class="text-brass">Authorization: Bearer ...</code> in headers/env as your client expects.</li>
        <li>If tools don’t show up, fully restart your MCP client after config changes.</li>
      </ul>
    </div>
  </section>
</Base>
