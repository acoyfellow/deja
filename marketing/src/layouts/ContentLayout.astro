---
import Base from './Base.astro';
import Sidebar from '../components/Sidebar.astro';
import TableOfContents from '../components/TableOfContents.astro';

interface Entry {
  id: string;
  data: {
    title: string;
    category?: string;
  };
}

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  title: string;
  description?: string;
  collection: string;
  allEntries: Entry[];
  currentCategory?: string;
  headings: Heading[];
}

const { title, description, collection, allEntries, currentCategory, headings } = Astro.props;

// Derive current slug from URL
const segments = Astro.url.pathname.split('/').filter(Boolean);
const currentSlug = segments[segments.length - 1];
---

<Base title={`${title} â€” deja`} description={description}>
  <slot name="head" slot="head" />

  <div class="grid grid-cols-1 lg:grid-cols-[220px_1fr_180px] gap-8 pt-8">
    <!-- Left sidebar: collection nav -->
    <aside class="hidden lg:block">
      <div class="sticky top-24">
        <Sidebar collection={collection} entries={allEntries} currentSlug={currentSlug} />
      </div>
    </aside>

    <!-- Center: main content -->
    <div class="min-w-0">
      <!-- Breadcrumbs slot -->
      <slot name="breadcrumbs" />

      <!-- Mobile ToC toggle -->
      <details class="lg:hidden mb-6 border border-brass/10 rounded-sm bg-steel/50">
        <summary class="flex items-center gap-2 px-4 py-3 cursor-pointer font-mono text-[11px] text-chrome-dark/60 hover:text-chrome-dark/80 transition-colors select-none">
          <svg class="w-3 h-3 transition-transform mobile-toc-arrow" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 18l6-6-6-6"/>
          </svg>
          On this page
        </summary>
        <div class="px-4 pb-3">
          <TableOfContents headings={headings} />
        </div>
      </details>

      <!-- Article content -->
      <article class="prose-deja">
        <slot />
      </article>

      <!-- Agent meta slot -->
      <slot name="agent-meta" />

      <!-- Related content slot -->
      <slot name="related" />

      <!-- Prev/Next slot -->
      <slot name="prev-next" />
    </div>

    <!-- Right sidebar: table of contents -->
    <aside class="hidden lg:block">
      <div class="sticky top-24">
        <TableOfContents headings={headings} />
      </div>
    </aside>
  </div>
</Base>

<style>
  details[open] .mobile-toc-arrow {
    transform: rotate(90deg);
  }

  /* Prose styling for content pages */
  .prose-deja {
    font-family: var(--font-family-serif);
    color: var(--color-chrome);
    line-height: 1.75;
  }

  .prose-deja :global(h1) {
    font-family: var(--font-family-serif-sc);
    font-size: 2.25rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin: 0 0 1rem;
    color: var(--color-chrome);
  }

  .prose-deja :global(h2) {
    font-family: var(--font-family-serif-sc);
    font-size: 1.5rem;
    font-weight: 600;
    letter-spacing: -0.01em;
    margin: 2.5rem 0 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(201, 169, 97, 0.1);
    color: var(--color-chrome);
  }

  .prose-deja :global(h3) {
    font-family: var(--font-family-serif);
    font-size: 1.2rem;
    font-weight: 600;
    margin: 2rem 0 0.5rem;
    color: var(--color-chrome);
  }

  .prose-deja :global(h4) {
    font-family: var(--font-family-mono);
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 1.5rem 0 0.5rem;
    color: var(--color-brass);
  }

  .prose-deja :global(p) {
    margin: 0 0 1.25rem;
    color: var(--color-chrome-dark);
  }

  .prose-deja :global(a) {
    color: var(--color-brass);
    text-decoration: underline;
    text-decoration-color: rgba(201, 169, 97, 0.3);
    text-underline-offset: 2px;
    transition: text-decoration-color 0.2s;
  }

  .prose-deja :global(a:hover) {
    text-decoration-color: var(--color-brass);
  }

  .prose-deja :global(strong) {
    color: var(--color-chrome);
    font-weight: 600;
  }

  .prose-deja :global(code) {
    font-family: var(--font-family-mono);
    font-size: 0.8em;
    background: var(--color-void-deep);
    border: 1px solid rgba(201, 169, 97, 0.1);
    border-radius: 2px;
    padding: 0.15em 0.4em;
    color: var(--color-brass-light);
  }

  .prose-deja :global(pre) {
    margin: 0 0 1.5rem;
    padding: 0;
    background: transparent;
    border: none;
  }

  .prose-deja :global(pre code) {
    background: transparent;
    border: none;
    padding: 0;
    font-size: 0.8rem;
  }

  .prose-deja :global(ul),
  .prose-deja :global(ol) {
    margin: 0 0 1.25rem;
    padding-left: 1.5rem;
    color: var(--color-chrome-dark);
  }

  .prose-deja :global(li) {
    margin-bottom: 0.35rem;
  }

  .prose-deja :global(blockquote) {
    border-left: 3px solid var(--color-brass);
    margin: 1.5rem 0;
    padding: 0.75rem 1rem;
    background: rgba(201, 169, 97, 0.03);
    color: var(--color-chrome-dark);
  }

  .prose-deja :global(blockquote p) {
    margin: 0;
  }

  .prose-deja :global(hr) {
    border: none;
    border-top: 1px solid rgba(201, 169, 97, 0.1);
    margin: 2rem 0;
  }

  .prose-deja :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
  }

  .prose-deja :global(th) {
    font-family: var(--font-family-mono);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-align: left;
    padding: 0.5rem 0.75rem;
    border-bottom: 2px solid rgba(201, 169, 97, 0.2);
    color: var(--color-brass);
  }

  .prose-deja :global(td) {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid rgba(201, 169, 97, 0.06);
    color: var(--color-chrome-dark);
  }

  .prose-deja :global(img) {
    max-width: 100%;
    border-radius: 2px;
    border: 1px solid rgba(201, 169, 97, 0.1);
    margin: 1.5rem 0;
  }
</style>
