---
/**
 * SEO component for deja pages
 * Handles meta tags and structured data (no og:image - handled in Base layout)
 */

interface Breadcrumb {
  name: string;
  path: string;
}

interface Props {
  title: string;
  description: string;
  keywords?: string;
  path: string;
  type?: 'website' | 'article';
  author?: string;
  publishedTime?: string;
  modifiedTime?: string;
  section?: string;
  tags?: string[];
  breadcrumbs?: Breadcrumb[];
  collectionType?: 'integration' | 'guide' | 'pattern' | 'prompt' | 'use-case';
}

const baseUrl = 'https://deja.coey.dev';

const {
  title,
  description,
  keywords = 'ai, agents, memory, cloudflare, workers, llm, durable objects, vectorize',
  path,
  type = 'website',
  author = 'deja',
  publishedTime,
  modifiedTime,
  section,
  tags = [],
  breadcrumbs = [],
  collectionType,
} = Astro.props;

const canonicalUrl = `${baseUrl}${path}`;

// Organization schema
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'deja',
  url: baseUrl,
  logo: {
    '@type': 'ImageObject',
    url: `${baseUrl}/icon.svg`,
  },
  sameAs: [
    'https://github.com/acoyfellow/deja',
  ],
};

// Software Application schema
const softwareSchema = {
  '@context': 'https://schema.org',
  '@type': 'SoftwareApplication',
  name: 'deja',
  applicationCategory: 'DeveloperApplication',
  operatingSystem: 'Cloudflare Workers',
  description: 'Persistent memory for AI agents. Open source Cloudflare Worker.',
  url: baseUrl,
  author: {
    '@type': 'Organization',
    name: 'deja',
  },
  license: 'https://opensource.org/licenses/MIT',
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD',
  },
};

// Breadcrumb schema
const breadcrumbSchema = breadcrumbs.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: baseUrl,
    },
    ...breadcrumbs.map((crumb, index) => ({
      '@type': 'ListItem',
      position: index + 2,
      name: crumb.name,
      item: `${baseUrl}${crumb.path}`,
    })),
  ],
} : null;

// Article schema (for docs/patterns pages)
const articleSchema = type === 'article' ? {
  '@context': 'https://schema.org',
  '@type': 'TechArticle',
  headline: title,
  description: description,
  author: {
    '@type': 'Organization',
    name: author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'deja',
    logo: {
      '@type': 'ImageObject',
      url: `${baseUrl}/icon.svg`,
    },
  },
  datePublished: publishedTime || '2025-01-01',
  dateModified: modifiedTime || new Date().toISOString().split('T')[0],
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl,
  },
} : null;

// HowTo schema for integration pages
const howToSchema = collectionType === 'integration' ? {
  '@context': 'https://schema.org',
  '@type': 'HowTo',
  name: title,
  description: description,
  step: [
    { '@type': 'HowToStep', name: 'Deploy deja', text: 'Deploy a deja instance to Cloudflare Workers' },
    { '@type': 'HowToStep', name: 'Configure connection', text: 'Connect your tool using MCP, REST API, or deja-client' },
    { '@type': 'HowToStep', name: 'Start learning', text: 'Call learn() to store memories and inject() to recall them' },
  ],
} : null;
---

<!-- Essential Meta Tags -->
<meta name="keywords" content={keywords} />
<meta name="author" content={author} />
<meta name="robots" content="index, follow" />

<!-- Open Graph (no image - handled in Base) -->
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="deja" />

<!-- Twitter (no image - handled in Base) -->
<meta name="twitter:site" content="@acoyfellow" />
<meta name="twitter:creator" content="@acoyfellow" />

{type === 'article' && publishedTime && (
  <meta property="article:published_time" content={publishedTime} />
)}
{type === 'article' && modifiedTime && (
  <meta property="article:modified_time" content={modifiedTime} />
)}
{type === 'article' && section && (
  <meta property="article:section" content={section} />
)}
{type === 'article' && tags.map(tag => (
  <meta property="article:tag" content={tag} />
))}

<!-- Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
<script type="application/ld+json" set:html={JSON.stringify(softwareSchema)} />
{breadcrumbSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
)}
{articleSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
)}
{howToSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(howToSchema)} />
)}
